<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Rushi Tech - Course Registration</title>
 <link href="css/rushi-style.css" rel="stylesheet" type="text/css"/>
</head>
<div class="header">
    <span> Rushi Technologies - Balaji Reddy Lachhannagari</span>
</div>
<div class="container">
        <button onclick="openModal()">Add Registration</button>

        <!-- Success Notification -->
        <div id="successMsg" class="success-message" style="display:none; color:green; font-weight:bold; margin:10px 0;"></div>
        <!-- Modal for Add/Edit Registration -->
        <div id="regModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2 id="modalTitle">Add Registration</h2>
                <form id="regForm">
                    <input type="hidden" id="regId" />
                    <label>Name:</label>
                    <input type="text" id="name" required />
                    <label>Email:</label>
                    <input type="email" id="email" required />
                    <label>Phone:</label>
                    <input type="text" id="phone" required pattern="^[0-9]{10}$" />
                    <label>Course:</label>
                    <select id="course" required>
                        <option value="" disabled selected>Select Course</option>
                        <option>DevOps</option>
                        <option>AWS</option>
                        <option>Azure</option>
                        <option>Terraform</option>
                        <option>Kubernetes</option>
                        <option>Python</option>
                    </select>
                    <button type="submit" id="saveBtn">Save</button>
                </form>
            </div>
        </div>
    </form>

        <h2>Registrations</h2>
        <table id="regTable" border="1" style="width:100%;margin-top:20px;">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Course</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <script>
            // Dynamically detect context path
            const pathParts = window.location.pathname.split('/');
            let contextPath = '';
            if (pathParts.length > 1 && pathParts[1] && pathParts[1] !== 'api') {
                contextPath = '/' + pathParts[1];
            }

            // Modal logic
            function openModal(edit=false, reg={}) {
                document.getElementById('regModal').style.display = 'block';
                document.getElementById('modalTitle').innerText = edit ? 'Edit Registration' : 'Add Registration';
                document.getElementById('regId').value = reg.id || '';
                document.getElementById('name').value = reg.name || '';
                document.getElementById('email').value = reg.email || '';
                document.getElementById('phone').value = reg.phone || '';
                document.getElementById('course').value = reg.course || '';
            }
            function closeModal() {
                document.getElementById('regModal').style.display = 'none';
                document.getElementById('regForm').reset();
            }

            // Fetch and render registrations
            function fetchRegistrations() {
                fetch(`${contextPath}/api/registrations`)
                    .then(res => res.json())
                    .then(data => {
                        const tbody = document.querySelector('#regTable tbody');
                        tbody.innerHTML = '';
                        data.forEach(reg => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${reg.name}</td>
                                <td>${reg.email}</td>
                                <td>${reg.phone}</td>
                                <td>${reg.course}</td>
                                <td>
                                    <button onclick='editReg(${JSON.stringify(reg)})'>Edit</button>
                                    <button onclick='deleteReg(${reg.id})'>Delete</button>
                                </td>
                            `;
                            tbody.appendChild(tr);
                        });
                    });
            }
            fetchRegistrations();

            // Add/Edit registration
            document.getElementById('regForm').onsubmit = function(e) {
                e.preventDefault();
                const id = document.getElementById('regId').value;
                const reg = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    course: document.getElementById('course').value
                };
                const method = id ? 'PUT' : 'POST';
                const url = id ? `${contextPath}/api/registrations/${id}` : `${contextPath}/api/registrations`;
                fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(reg)
                })
                .then(res => {
                    closeModal();
                    fetchRegistrations();
                    showSuccess(id ? 'Registration updated successfully!' : 'Registration added successfully!');
                });
            };

            function showSuccess(msg) {
                const el = document.getElementById('successMsg');
                el.innerText = msg;
                el.style.display = 'block';
                setTimeout(() => { el.style.display = 'none'; }, 3000);
            }

            // Edit registration
            window.editReg = function(reg) {
                openModal(true, reg);
            };

            // Delete registration
            window.deleteReg = function(id) {
                if(confirm('Are you sure you want to delete this registration?')) {
                    fetch(`${contextPath}/api/registrations/${id}`, { method: 'DELETE' })
                        .then(res => fetchRegistrations());
                }
            };
        </script>

    <div class="trainer-section">
        <div class="trainer-logos">
            <img th:src="@{/images/logo.png}" alt="Rushi Logo" class="logo-img" />
            <img th:src="@{/images/trainer.jpg}" alt="Trainer Photo" class="trainer-img" />
        </div>
        <div class="trainer-info">
            <p><strong>Trainer:</strong> <b>Mr. Balaji Reddy L</b><br />
                <strong>Contact:</strong> <b>+91-9900012028</b><br />
                <strong>Server IP:</strong> <span th:text="${serverIp}"></span><br />
                <strong>Client IP:</strong> <span th:text="${clientIp}"></span>
            </p>
        </div>
    </div>

</div>
</body>

</html>
